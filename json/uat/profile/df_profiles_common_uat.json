{
  "name": "df_profiles_common_uat",
  "properties": {
    "folder": {
      "name": "ccore/TDATA-4433/uat"
    },
    "type": "MappingDataFlow",
    "typeProperties": {
      "sources": [
        {
          "dataset": {
            "referenceName": "ds_cntnr_na_profiles_retained_uat",
            "type": "DatasetReference"
          },
          "name": "RetainedNaProfile"
        },
        {
          "dataset": {
            "referenceName": "ds_cntnr_ca_profiles_retained_uat",
            "type": "DatasetReference"
          },
          "name": "RetainedCaProfile"
        }
      ],
      "sinks": [
        {
          "dataset": {
            "referenceName": "ds_cntnr_na_profiles_common_uat",
            "type": "DatasetReference"
          },
          "name": "commonProfiles"
        }
      ],
      "transformations": [
        {
          "name": "NaJoinCa"
        },
        {
          "name": "selectRequiredColumns"
        }
      ],
      "scriptLines": [
        "source(output(",
        "          bannerOfOrigin as string,",
        "          birthday as date,",
        "          changedBy as string,",
        "          changedFields as string,",
        "          country as string,",
        "          created as long,",
        "          createdBy as string,",
        "          csaInfo as (csaAgentEmail as string, zendeskTicketNumber as string),",
        "          customerFlag as string,",
        "          customerId as string,",
        "          email as string,",
        "          emailHistory as (emailAddress as string, modificationTS as string)[],",
        "          emailVerified as long,",
        "          enrollmentSource as string,",
        "          event as string,",
        "          failedLoginAttempts as integer,",
        "          firstName as string,",
        "          flxInfo as (ctNumber as integer, flxEmailOptIn as boolean, flxNumber as integer, flxTcVersion as string, loyaltyFlxEmailOptInBanner as string, loyaltyStatus as boolean, points as integer, referralCode as string, tier as string),",
        "          fraudFlag as string[],",
        "          gender as string,",
        "          homeNumber as long,",
        "          inStoreSignUp as boolean,",
        "          isRegistered as boolean,",
        "          janrainUuid as string,",
        "          lastFailedLogin as string,",
        "          lastLogin as string,",
        "          lastName as string,",
        "          militaryExpiryDate as string,",
        "          militaryRequestId as string,",
        "          militaryStatus as string,",
        "          mobileNumber as long,",
        "          oldCsCid as string,",
        "          oldEbCid as string,",
        "          oldFaCid as string,",
        "          oldFlCid as string,",
        "          oldFlcaCid as string,",
        "          oldFsCid as string,",
        "          oldKflCid as string,",
        "          oldLflCid as string,",
        "          optIns as (banner as string)[],",
        "          password as string,",
        "          passwordChangeDate as string,",
        "          preferredLanguage as string,",
        "          preferredStores as (CS as (city as string, country as string, division as short, isocodeShort as string, latitude as double, line1 as string, line2 as string, longitude as double, name as string, phone as string, state as string, status as string, storeId as integer, zipcode as integer), FA as (city as string, country as string, division as short, isocodeShort as string, latitude as double, line1 as string, line2 as string, longitude as double, name as string, phone as string, state as string, status as string, storeId as integer, zipcode as integer), FL as (city as string, country as string, division as short, isocodeShort as string, latitude as double, line1 as string, line2 as string, longitude as double, name as string, phone as string, state as string, status as string, storeId as integer, zipcode as integer), KFL as (city as string, country as string, division as short, isocodeShort as string, latitude as double, line1 as string, line2 as string, longitude as double, name as string, phone as string, state as string, status as string, storeId as integer, zipcode as integer), LFL as (city as string, zipcode as integer, name as string, state as string, storeId as short, country as string, isocodeShort as string, division as short, line1 as string, line2 as string, phone as string)),",
        "          previousEmail as string,",
        "          profileStatus as string,",
        "          relateCustomerId as integer,",
        "          relateFailure as boolean,",
        "          retailStoreId as integer,",
        "          schDefaultBillingAddressLine1 as string,",
        "          schDefaultShippingAddressLine1 as string,",
        "          storeNumber as string,",
        "          streetAddress as string,",
        "          token as string,",
        "          updateTs as long,",
        "          updateTsExceptLogin as long,",
        "          webhookMessageStatus as string,",
        "          xstoreId as string,",
        "          zipCode as string",
        "     ),",
        "     allowSchemaDrift: true,",
        "     validateSchema: false,",
        "     format: 'document') ~> RetainedNaProfile",
        "source(output(",
        "          bannerOfOrigin as string,",
        "          birthday as date,",
        "          changedBy as string,",
        "          changedFields as string,",
        "          country as string,",
        "          created as long,",
        "          createdBy as string,",
        "          csaInfo as (csaAgentEmail as string, zendeskTicketNumber as short),",
        "          customerFlag as string,",
        "          customerId as string,",
        "          email as string,",
        "          emailHistory as (emailAddress as string, modificationTS as string)[],",
        "          emailVerified as long,",
        "          event as string,",
        "          failedLoginAttempts as integer,",
        "          firstName as string,",
        "          flxInfo as (ctNumber as integer, flxEmailOptIn as boolean, flxNumber as integer, flxTcVersion as string, loyaltyFlxEmailOptInBanner as string, loyaltyStatus as boolean, points as integer, referralCode as string, tier as string),",
        "          fraudFlag as string[],",
        "          homeNumber as long,",
        "          inStoreSignUp as boolean,",
        "          isRegistered as boolean,",
        "          janrainUuid as string,",
        "          lastFailedLogin as string,",
        "          lastLogin as string,",
        "          lastName as string,",
        "          militaryExpiryDate as string,",
        "          militaryRequestId as string,",
        "          militaryStatus as string,",
        "          mobileNumber as long,",
        "          oldCsCid as string,",
        "          oldEbCid as string,",
        "          oldFaCid as string,",
        "          oldFlCid as string,",
        "          oldFlcaCid as string,",
        "          oldFsCid as string,",
        "          oldKflCid as string,",
        "          oldLflCid as string,",
        "          optIns as (banner as string)[],",
        "          passwordChangeDate as string,",
        "          preferredLanguage as string,",
        "          previousEmail as string,",
        "          profileStatus as string,",
        "          relateFailure as boolean,",
        "          schDefaultBillingAddressLine1 as string,",
        "          schDefaultShippingAddressLine1 as string,",
        "          storeNumber as string,",
        "          token as string,",
        "          updateTs as long,",
        "          updateTsExceptLogin as long,",
        "          vipInfo as (dollarsNeedToSpend as (currencyIso as string, formattedValue as string, value as short), dollarsSpent as (currencyIso as string, formattedValue as string, value as short), isVip as boolean, lastLevelMoveDate as long, lastLevelUpdateDateHyb as long, lifeTimePoints as integer, loyaltyExpireDate as long, loyaltyMinThreshold as (currencyIso as string, formattedValue as string, value as integer), loyaltyTargetThreshold as (currencyIso as string, formattedValue as string, value as short), status as string, vipNumber as string),",
        "          webhookMessageStatus as string,",
        "          xstoreId as string,",
        "          zipCode as string",
        "     ),",
        "     allowSchemaDrift: true,",
        "     validateSchema: false,",
        "     format: 'document') ~> RetainedCaProfile",
        "RetainedNaProfile, RetainedCaProfile join(RetainedNaProfile@email == RetainedCaProfile@email,",
        "     joinType:'inner',",
        "     matchType:'exact',",
        "     ignoreSpaces: false,",
        "     broadcast: 'auto')~> NaJoinCa",
        "NaJoinCa select(mapColumn(",
        "          naCustomerId = RetainedNaProfile@customerId,",
        "          email = RetainedNaProfile@email,",
        "          naJanrainUuid = RetainedNaProfile@janrainUuid,",
        "          caCustomerId = RetainedCaProfile@customerId,",
        "          caJanrainUuid = RetainedCaProfile@janrainUuid",
        "     ),",
        "     skipDuplicateMapInputs: true,",
        "     skipDuplicateMapOutputs: true) ~> selectRequiredColumns",
        "selectRequiredColumns sink(allowSchemaDrift: true,",
        "     validateSchema: false,",
        "     input(",
        "          lastName as string,",
        "          flxInfo as (flxEmailOptIn as string, loyaltyStatus as boolean, flxTcVersion as string, tier as string, flxNumber as string, ctNumber as string, points as string, loyaltyFlxEmailOptInBanner as string),",
        "          created as string,",
        "          profileStatus as string,",
        "          changedFields as string,",
        "          emailHistory as string[],",
        "          firstName as string,",
        "          militaryStatus as string,",
        "          janrainUuid as string,",
        "          inStoreSignUp as boolean,",
        "          createdBy as string,",
        "          customerId as string,",
        "          isRegistered as boolean,",
        "          event as string,",
        "          email as string,",
        "          birthday as string,",
        "          changedBy as string,",
        "          oldFlCid as string,",
        "          oldCsCid as string,",
        "          oldFaCid as string,",
        "          oldEbCid as string,",
        "          zipCode as string,",
        "          mobileNumber as integer,",
        "          schDefaultShippingAddressLine1 as string,",
        "          schDefaultBillingAddressLine1 as string,",
        "          country as string,",
        "          storeNumber as string,",
        "          preferredLanguage as string,",
        "          relateCustomerId as string,",
        "          token as string,",
        "          bannerOfOrigin as string",
        "     ),",
        "     deletable:false,",
        "     insertable:true,",
        "     updateable:false,",
        "     upsertable:false,",
        "     recreate:true,",
        "     format: 'document',",
        "     batchSize: 5000,",
        "     partitionKey: ['/id'],",
        "     throughput: 1000,",
        "     skipDuplicateMapInputs: true,",
        "     skipDuplicateMapOutputs: true) ~> commonProfiles"
      ]
    }
  }
}